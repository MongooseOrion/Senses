# 汇编指令

## 指令的寻址方式

### 寄存器寻址

寄存器寻址就是直接以通用寄存器作为操作数。例如：

```
MOV A,R0
```
上述语句表明了将通用寄存器 `R0` 中的内容传送给累加器寄存器 `A`。

### 直接寻址

直接寻址就是在指令中直接给出操作数的地址。例如：

```
MOV A,3AH
```

其中，`3AH` 是直接地址，表示内部 RAM 的 `3A` 单元，`H` 表示 16 进制。该语句表示将 `3A` 单元中的数据传送给 `A`。

### 立即寻址

如果指令的操作数是一个 8 位二进制数或 16 位二进制数，就称为立即寻址。例如：

```
MOV A,#3AH
```
其中，井号是为了与直接寻址进行区分，一个是操作地址，一个是直接操作数。例如在直接寻址中，假设 `3A` 地址中存放的是数 `6BH`，则 A=6B；而在立即寻址中，A=3A。

### 寄存器间接寻址

如果寄存器中存放的是操作数的地址，那么叫做寄存器间接寻址，如果是这种寻址方式，会在寄存器前加 `@`。例如：

```
        MOV R7,#20      // 将立即数 2'b20 送到通用寄存器 R7
        MOV R0,#30H     // 将立即数 2'h30 送到通用寄存器 R0
LOOP:   MOV A,@R0       // 取出 R0 的值，把这个值作为地址，然后把这个地址单元的内容送入 A，该指令等价于直接寻址指令：MOV A,30H
        INC R0          // 把 R0 中的值加一
        DJNZ R7,LOOP    // 将 R7 的值减一，然后判断值是否等于 0，如果不等于 0，则跳转到 LOOP 处执行，并继续执行后续的指令，直到 R7 减一操作减到 0
```

上述代码实现了一个从地址 30H 开始取 20 个地址单元内的数值（30H, 31H,...,44H），并分别送入 `A` 中的功能。

### 变址寻址

变址寻址是以某个寄存器的内容为基本地址，然后在这个地址的基础上加一个地址偏移量，得到最终的操作数地址。这个地址单元的内容作为最终的操作数。例如：

```
MOVC A,@A+DPTR
```

其中，`DPTR` 为数据指针，基本地址也可以用程序计数器 PC 表示。如果假设 `A=54H`、`DPTR=3F21H`，则操作数的地址应该是 `4'h3F21+2'h54=4'h3F75`。所以该指令执行后，会将程序存储器 `3F75` 单元中的内容传送给 `A`。

## 数据传送指令

数据传送指令为：
```
MOV <目的操作数>,<源操作数>
```

例如：

```
MOV R0,#7FH         // 将立即数 7FH 传送到寄存器 R0，即 7FH \to R0
MOV @R0,#90H        // 将立即数 90H 传送到寄存器 R0 所指向的 RAM 地址，即 90H \to RAM_7FH
MOV A,7FH           // 将 7FH 所指向的 RAM 地址的数据传送到 A，即 RAM_7FH \to A
MOV @R0,67H         // 将 67H 所指向的 RAM 地址的数据传送到 R0 所指向的 RAM 地址，即 RAM_67H \to RAM_7FH
MOV A,R0            // 将 R0 存储的数据传送到 A，即 R0 \to A
```

## 外部存储器的数据传送指令

### 16 位地址传送指令

DRTR 是一种在 MCS-51 系列单片机中使用的16位数据指针寄存器。DPTR 可以用来存储任意的 16 位地址，它可以被用来访问内部或外部的存储器，如 RAM、ROM 或外设寄存器等。

例如：
```
MOV DPTR,#1234H
```
该指令将会把立即数高 8 位数传送到 8 位寄存器 DPH 中，低 8 位数传送到 8 位寄存器 DPL 中。

执行该指令后，`DPH` 的值为 12H，`DPL` 的值为 34H。下述指令亦可以实现一样的效果：
```
MOV DPH,#12H
MOV DPL,#34H
```

### 访问外部 RAM 指令

该指令格式为：
```
MOVX <目的操作数>,<源操作数>
```

其用法与 `MOV` 没有区别。值得注意的是，对于 51 系统来说，如果使用内部通用寄存器 `Ri` 来间接寻址，则只能传送外部地址 256 个单元的数据，这是因为它们是 8 位的寄存器，如果需要对整个 64Kb 的 RAM 网络进行寻址,需要使用 `DPTR`。

### 访问外部 ROM 指令

这类指令有两个：
```
MOVC A,@A+DPTR
MOVC A,@A+PC
```

第一条指令将 `DPTR` 存储的数值与 `A` 的数值相加，得到指向 ROM 的地址，并将该地址的内容再传送给 `A`，即 ROM_{A+DPTR} $\to$ A。

第二条指令会把累加器 `A` 的值设置为代码存储器地址为 A+PC 的内存单元中存储的数据。其中，`PC` 为程序计数器，它指向下一条要执行的指令的地址。所以，A+PC 实际上是一个地址偏移量（这意味着 `A` 要有初值），用于计算代码存储器中要读取的数据所在的地址。

### 堆栈操作指令

堆栈是对地址的操作，指将多个数据按地址顺序存放，满足 “先进后出，后进先出” 的原则。为指示堆栈的地址索引，存在堆栈指示器 `SP`。

例如下述代码：
```
MOV SP,#5FH
MOV A,#10
MOV B,#20
PUSH ACC
PUSH B
POP B
POP ACC
```
第四行指令实现数据进栈，在执行时先对 `SP` 加一，然后将寄存器 `A` 的内容存放到索引为 SP+1 的地址中。即 `A` $\to$ RAM_{SP+1}（内存 60H 中的数值为 10），其中 `ACC` 表示仅将 `A` 中低八位数据进行操作，`A` 是一个 16 位的寄存器。

第五行指令与第四行指令实行一样的操作，`SP` 会先加一，然后将 `B` 的内容存放到 SP+1 对应的地址中。此时地址为 61H 的 RAM 单元存放数据 20。

第六行指令实现数据出栈，`SP` 对应的 RAM 地址的数据被取出给 `B`，然后 SP-1。此时，索引为 61H 的 RAM 单元数据 20 被取出然后传送给 `B`，然后 `SP=60H`。

第七行指令，将索引为 60H 的 RAM 单元数据 10 被取出然后传送给 `A`，然后 `SP=5FH`。

<br><br>利用堆栈也可以实现数据交换，例如:
```
// 初值：SP=5FH
PUSH 40H
PUSH 43H
POP 40H
POP 43H
```

在上述代码中，RAM 单元 40H 的数据被存放到地址 60H 处，地址 43H 的数据被存放到地址 61H 处；然后数据被取出时，地址 61H 的数据先出栈，被传送到地址 40H 处，地址 60H 的数据被传送到 43H 处。这样就实现了地址 40H 和 43H 的数据相交换的功能。

### 数据交换指令

该指令包括：
```
// 整字节交换
XCH A,Rn
XCH A,direct
XCH A,@Ri

// 半字节交换
XCHD A,@Ri
```

可用于内部 RAM 和累加器 `A` 之间进行数据交换。对于半字节交换指令，只会将 `A` 的低 4 位和 `Ri` 间接寻址单元的低 4 位交换，而各自的高四位内容不变。

